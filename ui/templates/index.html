<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SelfObserver // PRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Theme (Apple/Glass) */
            --bg-gradient: radial-gradient(circle at 0% 0%, rgba(200, 220, 255, 0.4) 0%, transparent 50%),
                           radial-gradient(circle at 100% 0%, rgba(255, 220, 220, 0.4) 0%, transparent 50%),
                           radial-gradient(circle at 100% 100%, rgba(220, 255, 240, 0.4) 0%, transparent 50%),
                           radial-gradient(circle at 0% 100%, rgba(240, 220, 255, 0.4) 0%, transparent 50%);
            --card-bg: rgba(255, 255, 255, 0.65);
            --card-border: rgba(255, 255, 255, 0.4);
            --text-main: #1d1d1f;
            --text-sub: #6e6e73;
            --accent-color: #34c759;
            --ring-1: #ff3b30;
            --ring-2: #34c759;
            --ring-3: #007aff;
            --input-bg: rgba(255, 255, 255, 0.4);
            --menu-bg: rgba(255, 255, 255, 0.85);
            --hover-bg: rgba(0, 0, 0, 0.05);
            --header-bg: rgba(255, 255, 255, 0.6);
            --font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            font-family: var(--font-family);
            background-color: #f5f5f7;
            color: var(--text-main);
            overflow-y: auto; 
            overflow-x: hidden;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        /* Ambient Background */
        .ambient-bg {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-gradient);
            z-index: -1;
            transition: background 1s ease;
        }

        /* Decoration Layer */
        #decoration-layer {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        /* Standard Card */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: 24px;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.01), 
                0 10px 15px -3px rgba(0, 0, 0, 0.01),
                0 0 0 1px rgba(0, 0, 0, 0.02);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1), box-shadow 0.4s ease, background-color 0.4s ease;
            position: relative;
            z-index: 10;
            will-change: transform, box-shadow;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.12);
        }

        /* Header Specific Glass */
        .header-glass {
            background: var(--header-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }

        /* Interactive Elements */
        button {
            transition: transform 0.2s ease, opacity 0.2s ease;
            outline: none;
        }
        button:active { transform: scale(0.95); }

        /* Typography */
        h1, h2, h3 { letter-spacing: -0.02em; }
        .text-main { color: var(--text-main); transition: color 0.5s ease; }
        .text-sub { color: var(--text-sub); transition: color 0.5s ease; }

        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 10px; }
        
        /* Animations */
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }
        .status-dot-active {
            box-shadow: 0 0 10px #34c759;
            animation: breathe 3s infinite ease-in-out;
            background-color: #34c759;
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }

        .tabular-nums { font-variant-numeric: tabular-nums; }
        
        /* Custom Dropdown Styles */
        .custom-dropdown-btn {
            background-color: var(--input-bg);
            border: 1px solid rgba(255,255,255,0.5);
            color: var(--text-main);
            transition: all 0.3s ease;
        }
        
        .custom-dropdown-menu {
            background-color: var(--menu-bg);
            border: 1px solid var(--card-border);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
        }

        .dropdown-item:hover {
            background-color: var(--hover-bg);
        }

        /* Ring Chart Container */
        .ring-container {
            position: relative;
            width: 140px;
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Dynamic SVG Coloring */
        .icon-dynamic {
            color: var(--text-main);
            transition: color 0.5s ease;
        }

        /* RGB Bar */
        @keyframes rainbow-cycle {
            0% { background-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
            16% { background-color: #ffff00; box-shadow: 0 0 15px #ffff00; }
            33% { background-color: #00ff00; box-shadow: 0 0 15px #00ff00; }
            50% { background-color: #00ffff; box-shadow: 0 0 15px #00ffff; }
            66% { background-color: #0000ff; box-shadow: 0 0 15px #0000ff; }
            83% { background-color: #ff00ff; box-shadow: 0 0 15px #ff00ff; }
            100% { background-color: #ff0000; box-shadow: 0 0 15px #ff0000; }
        }

        .rgb-bar {
            background-image: none !important; 
            animation: rainbow-cycle 2s linear infinite !important;
            transition: width 1s ease-out !important; 
        }

        /* Custom Checkbox */
        .custom-checkbox {
            appearance: none;
            background-color: var(--input-bg);
            margin: 0;
            width: 1.15em;
            height: 1.15em;
            border: 1px solid currentColor;
            border-radius: 0.35em;
            display: grid;
            place-content: center;
            cursor: pointer;
            opacity: 0.6;
            color: currentColor;
        }
        .custom-checkbox::before {
            content: "";
            width: 0.65em;
            height: 0.65em;
            transform: scale(0);
            transition: 120ms transform ease-in-out;
            box-shadow: inset 1em 1em var(--accent-color);
            border-radius: 2px;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .custom-checkbox:checked::before {
            transform: scale(1);
        }

        /* Music Visualizer Bars */
        @keyframes music-bar {
            0%, 100% { height: 20%; }
            50% { height: 100%; }
        }

        /* Scroll Bounce Indicator */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);} 
            40% {transform: translateY(-10px);} 
            60% {transform: translateY(-5px);} 
        }
        .scroll-hint {
            animation: bounce 2s infinite;
        }

        /* Squircle Icon */
        .squircle {
            border-radius: 22%;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2), 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Badge Styles */
        .badge-slot {
            background: var(--input-bg);
            border: 1px solid var(--card-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .badge-slot.earned {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent-color);
            box-shadow: 0 0 15px -5px var(--accent-color);
        }
        .badge-icon {
            filter: grayscale(100%) opacity(0.4);
            transition: all 0.5s ease;
        }
        .badge-slot.earned .badge-icon {
            filter: grayscale(0%) opacity(1);
            transform: scale(1.1);
        }

        /* --- DECORATION ANIMATIONS --- */
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0px) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            100% { transform: translateY(110vh) translateX(20px) rotate(360deg); opacity: 0.3; }
        }
        @keyframes float-up {
            0% { transform: translateY(110vh) translateX(0); opacity: 0; }
            20% { opacity: 0.6; }
            80% { opacity: 0.6; }
            100% { transform: translateY(-10vh) translateX(20px); opacity: 0; }
        }
        @keyframes twinkle {
            0%, 100% { opacity: 0.2; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        .deco-item { position: absolute; user-select: none; }

    </style>
</head>
<body class="min-h-screen flex flex-col p-6 max-w-[1600px] mx-auto transition-colors duration-500 pb-20">

    <div class="ambient-bg" id="bg-layer"></div>
    <div id="decoration-layer"></div>

    <!-- Header -->
    <header class="flex justify-between items-center mb-6 shrink-0 px-2 relative z-50 sticky top-6 pointer-events-none">
        
        <!-- Left Side: Branding -->
        <div class="pointer-events-auto">
            <div class="flex items-center gap-3 p-1.5 pr-5 rounded-2xl header-glass transition hover:scale-[1.02] cursor-default group">
                <div class="w-10 h-10 bg-white/40 rounded-xl flex items-center justify-center shadow-sm border border-white/20 transition group-hover:bg-white/60">
                    <svg class="w-5 h-5 icon-dynamic" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-main leading-tight">SelfObserver</h1>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full status-dot-active"></span>
                        <span class="text-[10px] font-medium text-sub">Monitoring Active</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Side: Controls -->
        <div class="flex items-center gap-3 pointer-events-auto">
            <div class="relative">
                <button id="theme-btn" onclick="toggleThemeMenu()" class="flex items-center gap-2 px-4 py-2.5 rounded-xl text-xs font-semibold header-glass hover:opacity-90 transition-all active:scale-95 text-main">
                    <span class="w-2.5 h-2.5 rounded-full bg-gradient-to-br from-blue-400 to-purple-500"></span>
                    <span id="current-theme-label">Original</span>
                    <svg class="w-3 h-3 ml-1 text-sub opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>
                <div id="theme-menu" class="hidden absolute top-full right-0 mt-2 w-56 custom-dropdown-menu rounded-2xl shadow-2xl overflow-hidden animate-[fadeIn_0.2s_ease-out]">
                    <div class="max-h-[60vh] overflow-y-auto custom-scroll py-2">
                        <div id="theme-list-container"></div>
                    </div>
                </div>
            </div>

            <div class="px-5 py-2.5 rounded-xl header-glass flex items-center gap-3 hover:opacity-90 transition-all cursor-default">
                <span id="clock" class="text-xs font-bold text-main tabular-nums">00:00:00</span>
                <span class="text-[10px] text-main opacity-30">|</span>
                <span class="text-[10px] font-semibold text-sub uppercase tracking-wide">California</span>
            </div>
        </div>
    </header>

    <!-- SECTION 1: DASHBOARD VIEW -->
    <section class="grid grid-cols-1 md:grid-cols-12 gap-6 relative z-10 mb-12">

        <!-- LEFT COLUMN -->
        <div class="col-span-1 md:col-span-3 flex flex-col gap-6">
            <!-- Focus Card (h-48) -->
            <div class="glass-card p-6 flex flex-col justify-between h-48 shrink-0 relative overflow-hidden group cursor-default">
                <div>
                    <span class="text-xs font-bold text-sub uppercase tracking-wider">Current Focus</span>
                    <div id="stat-mode" class="text-3xl font-bold text-main mt-1 capitalize tracking-tight">Loading...</div>
                </div>
                <div>
                    <div class="flex justify-between text-xs font-medium text-sub mb-2">
                        <span>Intensity</span>
                        <span id="stat-conf">0%</span>
                    </div>
                    <div class="w-full bg-black/10 h-2 rounded-full overflow-hidden backdrop-blur-sm">
                        <div id="stat-bar" class="h-full rounded-full transition-all duration-1000 ease-out w-0"></div>
                    </div>
                </div>
            </div>

            <!-- Daily Goals (h-48) -->
            <div class="glass-card p-5 flex flex-col justify-center cursor-default h-48 shrink-0">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] font-bold text-sub uppercase tracking-wider">Daily Goals</span>
                    <span id="goals-summary" class="text-[10px] font-bold text-accent-color opacity-80">0/0</span>
                </div>
                <div id="goals-list" class="space-y-3 text-sub text-xs">
                    <div class="text-[11px] text-sub">Loading goalsâ€¦</div>
                </div>
            </div>

            <!-- Productivity Rings -->
            <div class="glass-card p-6 flex flex-col items-center justify-center h-80 shrink-0 cursor-default relative">
                <h3 class="absolute top-6 left-6 text-xs font-bold text-main uppercase tracking-widest opacity-80">Activity</h3>
                <div class="ring-container mt-2">
                    <canvas id="ringsCanvas" width="140" height="140"></canvas>
                </div>
                <div class="flex gap-6 mt-6 justify-center w-full px-4">
                    <div class="flex flex-col items-center">
                        <span id="ring-1-name" class="text-[9px] font-bold text-sub uppercase tracking-wider mb-1">Focus</span>
                        <span id="ring-1-value" class="text-sm font-bold" style="color: var(--ring-1)">0h</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span id="ring-2-name" class="text-[9px] font-bold text-sub uppercase tracking-wider mb-1">Work</span>
                        <span id="ring-2-value" class="text-sm font-bold" style="color: var(--ring-2)">0h</span>
                    </div>
                    <div class="flex flex-col items-center">
                        <span id="ring-3-name" class="text-[9px] font-bold text-sub uppercase tracking-wider mb-1">Sys</span>
                        <span id="ring-3-value" class="text-sm font-bold" style="color: var(--ring-3)">0h</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CENTER COLUMN -->
        <div class="col-span-1 md:col-span-6 flex flex-col gap-6">
            <!-- Line Chart -->
            <div class="glass-card p-6 h-[408px] flex flex-col shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-bold text-main">Activity Trend</h2>
                    <div class="bg-white/20 backdrop-blur-md p-0.5 rounded-lg flex text-[10px] font-semibold border border-white/20">
                        <button class="px-3 py-1 bg-white/80 shadow-sm rounded-md text-slate-900 cursor-pointer transition-colors">Today</button>
                        <button class="px-3 py-1 text-sub hover:text-main cursor-pointer transition-colors">Week</button>
                    </div>
                </div>
                <div class="relative w-full flex-1 min-h-0">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>

            <!-- Top Apps -->
            <div class="glass-card p-6 h-80 flex flex-col overflow-hidden shrink-0">
                <h2 class="text-sm font-bold text-main mb-4 flex items-center gap-2">
                    Top Applications
                    <span class="text-[10px] font-normal text-sub bg-white/30 px-1.5 py-0.5 rounded">Today</span>
                </h2>
                <div class="flex-1 overflow-y-auto pr-2 space-y-4 custom-scroll" id="top-apps-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-span-1 md:col-span-3 flex flex-col gap-6">
            <!-- System Vitals -->
            <div class="glass-card p-5 h-48 shrink-0 flex flex-col justify-between">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-sm font-bold text-main">System Vitals</h2>
                    <span class="text-[10px] font-mono text-sub bg-black/5 px-2 py-0.5 rounded">M2 CHIP</span>
                </div>
                <!-- CPU -->
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-semibold text-sub">
                        <span>CPU Load</span>
                        <span id="cpu-val">12%</span>
                    </div>
                    <div class="w-full bg-black/5 h-1.5 rounded-full overflow-hidden">
                        <div id="cpu-bar" class="h-full bg-blue-500 rounded-full transition-all duration-500" style="width: 12%"></div>
                    </div>
                </div>
                <!-- RAM -->
                <div class="space-y-1">
                    <div class="flex justify-between text-[10px] font-semibold text-sub">
                        <span>Memory</span>
                        <span id="ram-val">8.4 GB</span>
                    </div>
                    <div class="w-full bg-black/5 h-1.5 rounded-full overflow-hidden">
                        <div id="ram-bar" class="h-full bg-purple-500 rounded-full transition-all duration-500" style="width: 45%"></div>
                    </div>
                </div>
            </div>

            <!-- Music Widget -->
            <div class="glass-card p-4 h-48 flex flex-col justify-center gap-4 relative overflow-hidden group shrink-0">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-50"></div>
                <div class="flex items-center gap-4 relative z-10">
                    <div class="w-14 h-14 rounded-xl bg-black/20 flex items-center justify-center shadow-md relative overflow-hidden shrink-0">
                         <div class="flex items-end gap-0.5 h-6 opacity-70">
                             <div class="w-1 bg-white animate-[music-bar_1s_ease-in-out_infinite]"></div>
                             <div class="w-1 bg-white animate-[music-bar_1.2s_ease-in-out_infinite] animation-delay-100"></div>
                             <div class="w-1 bg-white animate-[music-bar_0.8s_ease-in-out_infinite] animation-delay-200"></div>
                         </div>
                    </div>
                    <div class="flex-1 min-w-0">
                        <div id="music-title" class="text-sm font-bold text-main truncate">Midnight City</div>
                        <div id="music-artist" class="text-[10px] font-medium text-sub truncate uppercase tracking-wider">M83</div>
                    </div>
                </div>
                
                <div class="w-full bg-black/10 h-1 rounded-full overflow-hidden relative z-10">
                    <div id="music-progress" class="h-full bg-accent-color w-0 transition-all duration-1000 ease-linear"></div>
                </div>

                <div class="flex items-center justify-center gap-4 text-main relative z-10">
                    <button onclick="skipSong(-1)" class="hover:text-accent-color transition-colors p-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                    <button onclick="togglePlay()" id="play-btn" class="w-10 h-10 rounded-full bg-white/20 text-main flex items-center justify-center hover:scale-105 hover:bg-white/40 transition-all shadow-sm"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                    <button onclick="skipSong(1)" class="hover:text-accent-color transition-colors p-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg></button>
                </div>
            </div>

            <!-- Live Feed -->
            <div class="glass-card h-80 flex flex-col overflow-hidden shrink-0">
                <div class="p-5 border-b border-white/20 flex justify-between items-center bg-white/10 backdrop-blur-sm">
                    <h2 class="text-sm font-bold text-main">Live Feed</h2>
                    <div class="flex gap-1">
                        <span class="w-2 h-2 rounded-full bg-red-400 cursor-pointer hover:bg-red-500 transition-colors"></span>
                        <span class="w-2 h-2 rounded-full bg-yellow-400 cursor-pointer hover:bg-yellow-500 transition-colors"></span>
                        <span class="w-2 h-2 rounded-full bg-green-400 cursor-pointer hover:bg-green-500 transition-colors"></span>
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto p-2 custom-scroll" id="log-container">
                    <table class="w-full text-left border-collapse">
                        <tbody id="log-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- SCROLL INDICATOR -->
    <div class="flex justify-center mb-12 scroll-hint relative z-10 opacity-60">
        <svg class="w-6 h-6 text-main" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
    </div>

    <!-- SECTION 2: DEEP ANALYTICS -->
    <section class="relative z-10 mb-12">
        <h2 class="text-2xl font-bold text-main mb-6 px-2">Deep Analytics</h2>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Weekly Analysis -->
            <div class="glass-card p-6 lg:col-span-2 h-80 flex flex-col">
                <h3 class="text-sm font-bold text-sub mb-4">Productivity vs Distraction (7 Days)</h3>
                <div class="flex-1 relative w-full">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            
            <!-- Focus Distribution -->
            <div class="glass-card p-6 h-80 flex flex-col">
                <h3 class="text-sm font-bold text-sub mb-4">Project Breakdown</h3>
                <div class="space-y-4 overflow-y-auto custom-scroll pr-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-600 font-bold text-xs">P1</div>
                            <span class="text-xs font-semibold text-main">Website Redesign</span>
                        </div>
                        <span class="text-xs font-bold text-sub">12.5h</span>
                    </div>
                    <div class="w-full bg-black/5 h-1 rounded-full"><div class="bg-blue-500 h-full rounded-full" style="width: 70%"></div></div>
                    
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-600 font-bold text-xs">P2</div>
                            <span class="text-xs font-semibold text-main">Backend API</span>
                        </div>
                        <span class="text-xs font-bold text-sub">8.2h</span>
                    </div>
                    <div class="w-full bg-black/5 h-1 rounded-full"><div class="bg-purple-500 h-full rounded-full" style="width: 45%"></div></div>

                    <div class="flex items-center justify-between mt-2">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-orange-500/20 flex items-center justify-center text-orange-600 font-bold text-xs">P3</div>
                            <span class="text-xs font-semibold text-main">Documentation</span>
                        </div>
                        <span class="text-xs font-bold text-sub">3.1h</span>
                    </div>
                    <div class="w-full bg-black/5 h-1 rounded-full"><div class="bg-orange-500 h-full rounded-full" style="width: 20%"></div></div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION 3: COGNITIVE METRICS & GAMIFICATION -->
    <section class="relative z-10 mb-12">
        <h2 class="text-2xl font-bold text-main mb-6 px-2">Cognitive & Gamification</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- Cognitive Metrics -->
            <div class="glass-card p-6 flex flex-col gap-6">
                <h3 class="text-sm font-bold text-sub uppercase tracking-wider">Flow State Tracker</h3>
                <!-- Flow Chart -->
                <div class="relative w-full h-40">
                    <canvas id="flowChart"></canvas>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <!-- Context Switching -->
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-[10px] font-bold text-sub uppercase">Context Switches</span>
                            <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                        </div>
                        <div class="text-3xl font-bold text-main">42<span class="text-sm font-normal text-sub ml-1">/hr</span></div>
                        <div class="text-[10px] text-red-400 mt-1 font-semibold">High fragmentation</div>
                    </div>
                    <!-- Odometer -->
                    <div class="bg-white/10 rounded-2xl p-4 border border-white/10">
                        <span class="text-[10px] font-bold text-sub uppercase block mb-2">Input Odometer</span>
                        <div class="flex flex-col gap-1">
                            <div class="flex justify-between items-baseline">
                                <span class="text-xl font-bold text-main tabular-nums">12,402</span>
                                <span class="text-[10px] text-sub">Keys</span>
                            </div>
                            <div class="w-full bg-black/10 h-1 rounded-full"><div class="bg-accent-color h-full w-[70%] rounded-full"></div></div>
                            <div class="flex justify-between items-baseline mt-1">
                                <span class="text-xl font-bold text-main tabular-nums">1,287</span>
                                <span class="text-[10px] text-sub">Meters</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Gamification Hub -->
            <div class="glass-card p-6 flex flex-col">
                <div class="flex justify-between items-end mb-4">
                    <div>
                        <span class="text-[10px] font-bold text-accent-color uppercase tracking-wider">Level 12</span>
                        <h3 class="text-xl font-bold text-main">Focus Guru</h3>
                    </div>
                    <span class="text-xs font-bold text-sub">2,450 / 3,000 XP</span>
                </div>
                
                <!-- XP Bar -->
                <div class="w-full bg-black/10 h-3 rounded-full mb-8 relative overflow-hidden">
                    <div class="absolute inset-0 bg-white/20 animate-pulse"></div>
                    <div class="h-full bg-gradient-to-r from-blue-400 to-purple-500 rounded-full" style="width: 82%"></div>
                </div>

                <h3 class="text-sm font-bold text-sub uppercase tracking-wider mb-4">Achievement Rack</h3>
                <div class="grid grid-cols-4 gap-4" id="badges-container">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
    </section>

    <!-- SECTION 4: SESSION HISTORY -->
    <section class="relative z-10 mb-6">
        <h2 class="text-2xl font-bold text-main mb-6 px-2">Session History</h2>
        <div class="glass-card overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="border-b border-white/20 bg-white/5">
                        <tr>
                            <th class="p-4 font-semibold text-sub">Time</th>
                            <th class="p-4 font-semibold text-sub">Activity</th>
                            <th class="p-4 font-semibold text-sub">Duration</th>
                            <th class="p-4 font-semibold text-sub">Efficiency</th>
                            <th class="p-4 font-semibold text-sub">Status</th>
                        </tr>
                    </thead>
                    <tbody id="history-body" class="divide-y divide-white/10 text-main">
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <script>
        // --- THEMES ---
        const THEMES = {
            apple: {
                name: 'Original',
                bg: 'radial-gradient(circle at 0% 0%, rgba(200, 220, 255, 0.4) 0%, transparent 50%), radial-gradient(circle at 100% 0%, rgba(255, 220, 220, 0.4) 0%, transparent 50%), radial-gradient(circle at 100% 100%, rgba(220, 255, 240, 0.4) 0%, transparent 50%), radial-gradient(circle at 0% 100%, rgba(240, 220, 255, 0.4) 0%, transparent 50%)',
                main: '#1d1d1f', sub: '#6e6e73', accent: '#34c759',
                r1: '#ff3b30', r2: '#34c759', r3: '#007aff',
                card: 'rgba(255, 255, 255, 0.65)', border: 'rgba(255, 255, 255, 0.4)',
                input: 'rgba(255, 255, 255, 0.4)', menu: 'rgba(255, 255, 255, 0.85)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.6)'
            },
            midnight: {
                name: 'Midnight ðŸŒ‘',
                bg: 'linear-gradient(to bottom, #0f2027, #203a43, #2c5364)',
                main: '#e2e8f0', sub: '#94a3b8', accent: '#38bdf8',
                r1: '#38bdf8', r2: '#818cf8', r3: '#c084fc',
                card: 'rgba(30, 41, 59, 0.7)', border: 'rgba(255, 255, 255, 0.1)',
                input: 'rgba(0, 0, 0, 0.4)', menu: 'rgba(30, 41, 59, 0.95)', hover: 'rgba(255,255,255,0.1)',
                header: 'rgba(30, 41, 59, 0.7)'
            },
            cyberpunk: {
                name: 'Cyberpunk ðŸ¤–',
                bg: 'linear-gradient(to bottom, #000000, #434343)',
                main: '#00ff9f', sub: '#d600ff', accent: '#f6ff00',
                r1: '#00e5ff', r2: '#d600ff', r3: '#f6ff00',
                card: 'rgba(10, 10, 10, 0.8)', border: 'rgba(0, 255, 159, 0.3)',
                input: 'rgba(0, 0, 0, 0.6)', menu: 'rgba(20, 20, 20, 0.95)', hover: 'rgba(0, 255, 159, 0.2)',
                header: 'rgba(10, 10, 10, 0.8)'
            },
            forest: {
                name: 'Forest ðŸŒ²',
                bg: 'linear-gradient(to right, #134e5e, #71b280)',
                main: '#ecfdf5', sub: '#a7f3d0', accent: '#f59e0b',
                r1: '#10b981', r2: '#f59e0b', r3: '#8b5cf6',
                card: 'rgba(6, 78, 59, 0.6)', border: 'rgba(255, 255, 255, 0.15)',
                input: 'rgba(0, 0, 0, 0.2)', menu: 'rgba(6, 78, 59, 0.9)', hover: 'rgba(255,255,255,0.1)',
                header: 'rgba(6, 78, 59, 0.7)'
            },
            ocean: {
                name: 'Ocean ðŸŒŠ',
                bg: 'linear-gradient(to bottom, #1a2980, #26d0ce)',
                main: '#f0f9ff', sub: '#b3e5fc', accent: '#00e5ff',
                r1: '#00bcd4', r2: '#4dd0e1', r3: '#80deea',
                card: 'rgba(20, 40, 60, 0.6)', border: 'rgba(0, 229, 255, 0.2)',
                input: 'rgba(0, 0, 0, 0.3)', menu: 'rgba(20, 40, 60, 0.9)', hover: 'rgba(255,255,255,0.1)',
                header: 'rgba(20, 40, 60, 0.7)'
            },
            sunset: {
                name: 'Sunset ðŸŒ…',
                bg: 'linear-gradient(to right, #ffecd2 0%, #fcb69f 100%)',
                main: '#5d4037', sub: '#8d6e63', accent: '#ff6f00',
                r1: '#ff9f43', r2: '#ff6b6b', r3: '#54a0ff',
                card: 'rgba(255, 255, 255, 0.5)', border: 'rgba(255, 255, 255, 0.6)',
                input: 'rgba(255, 255, 255, 0.4)', menu: 'rgba(255, 255, 255, 0.9)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.6)'
            },
            coffee: {
                name: 'Coffee â˜•',
                bg: 'linear-gradient(to top, #eacda3 0%, #d6ae7b 100%)',
                main: '#3e2723', sub: '#5d4037', accent: '#8d6e63',
                r1: '#795548', r2: '#a1887f', r3: '#d7ccc8',
                card: 'rgba(255, 250, 240, 0.7)', border: 'rgba(121, 85, 72, 0.2)',
                input: 'rgba(255, 255, 255, 0.5)', menu: 'rgba(255, 248, 240, 0.9)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 250, 240, 0.7)'
            },
            lavender: {
                name: 'Lavender ðŸ’œ',
                bg: 'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)',
                main: '#4a148c', sub: '#7b1fa2', accent: '#aa00ff',
                r1: '#9c27b0', r2: '#ba68c8', r3: '#e1bee7',
                card: 'rgba(255, 255, 255, 0.5)', border: 'rgba(255, 255, 255, 0.8)',
                input: 'rgba(255, 255, 255, 0.5)', menu: 'rgba(255, 255, 255, 0.9)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.6)'
            },
            candy: {
                name: 'Candy ðŸ¬',
                bg: 'linear-gradient(135deg, #ffc3a0 0%, #ffafbd 100%)',
                main: '#5e3a48', sub: '#916b7a', accent: '#ff6b6b',
                r1: '#ff9a9e', r2: '#a18cd1', r3: '#fbc2eb',
                card: 'rgba(255, 255, 255, 0.5)', border: 'rgba(255, 255, 255, 0.6)',
                input: 'rgba(255, 255, 255, 0.4)', menu: 'rgba(255, 255, 255, 0.9)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.6)'
            },
            barbie: {
                name: 'Barbie ðŸ’…',
                bg: 'linear-gradient(45deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)',
                main: '#d63384', sub: '#e685b5', accent: '#e83e8c',
                r1: '#ff007f', r2: '#ff69b4', r3: '#ffc0cb',
                card: 'rgba(255, 255, 255, 0.7)', border: 'rgba(255, 255, 255, 0.8)',
                input: 'rgba(255, 255, 255, 0.4)', menu: 'rgba(255, 255, 255, 0.9)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.8)'
            },
            christmas: {
                name: 'Christmas ðŸŽ„',
                bg: 'radial-gradient(circle at 0% 0%, rgba(210, 40, 40, 0.25) 0%, transparent 60%), radial-gradient(circle at 100% 100%, rgba(30, 100, 50, 0.25) 0%, transparent 60%), #fffaf0',
                main: '#1a4c30', sub: '#5c7c60', accent: '#d42426',
                r1: '#d42426', r2: '#2ecc71', r3: '#f1c40f',
                card: 'rgba(255, 255, 255, 0.85)', border: 'rgba(212, 36, 38, 0.1)',
                input: 'rgba(255, 255, 255, 0.6)', menu: 'rgba(255, 255, 255, 0.95)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.8)'
            },
            halloween: {
                name: 'Halloween ðŸŽƒ',
                bg: 'linear-gradient(to bottom right, #240b36, #c31432)',
                main: '#fcd5ce', sub: '#e0aaff', accent: '#ff9e00',
                r1: '#ff9e00', r2: '#9d4edd', r3: '#70e000',
                card: 'rgba(20, 10, 30, 0.6)', border: 'rgba(255, 158, 0, 0.2)',
                input: 'rgba(0, 0, 0, 0.3)', menu: 'rgba(20, 10, 30, 0.9)', hover: 'rgba(255,255,255,0.1)',
                header: 'rgba(20, 10, 30, 0.8)'
            },
            winter: {
                name: 'Winter â„ï¸',
                bg: 'linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)',
                main: '#2c3e50', sub: '#7f8c8d', accent: '#3498db',
                r1: '#3498db', r2: '#a8d0e6', r3: '#d6eaf8',
                card: 'rgba(255, 255, 255, 0.6)', border: 'rgba(255, 255, 255, 0.8)',
                input: 'rgba(255, 255, 255, 0.4)', menu: 'rgba(255, 255, 255, 0.9)',
                hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.7)'
            },
            summer: {
                name: 'Summer â˜€ï¸',
                bg: 'linear-gradient(120deg, #f6d365 0%, #fda085 100%)',
                main: '#e65100', sub: '#fb8c00', accent: '#ff6f00',
                r1: '#ff6f00', r2: '#ffca28', r3: '#4fc3f7',
                card: 'rgba(255, 255, 255, 0.6)', border: 'rgba(255, 255, 255, 0.6)',
                input: 'rgba(255, 255, 255, 0.4)', menu: 'rgba(255, 255, 255, 0.9)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 255, 255, 0.7)'
            },
            galaxy: {
                name: 'Galaxy ðŸŒŒ',
                bg: 'linear-gradient(to bottom, #000428, #004e92)',
                main: '#ffffff', sub: '#a0c4ff', accent: '#bc13fe',
                r1: '#bc13fe', r2: '#4facfe', r3: '#00f2fe',
                card: 'rgba(20, 20, 40, 0.6)', border: 'rgba(100, 200, 255, 0.2)',
                input: 'rgba(0, 0, 0, 0.4)', menu: 'rgba(10, 10, 30, 0.95)', hover: 'rgba(255, 255, 255, 0.1)',
                header: 'rgba(10, 10, 30, 0.8)'
            },
            terminal: {
                name: 'Terminal ðŸ“Ÿ',
                bg: 'linear-gradient(to bottom, #000000, #111111)',
                main: '#00ff00', sub: '#008f11', accent: '#00ff00',
                r1: '#00ff00', r2: '#00cc00', r3: '#008000',
                card: 'rgba(0, 20, 0, 0.8)', border: 'rgba(0, 255, 0, 0.4)',
                input: 'rgba(0, 20, 0, 0.8)', menu: 'rgba(0, 15, 0, 0.95)', hover: 'rgba(0, 255, 0, 0.1)',
                header: 'rgba(0, 20, 0, 0.9)'
            },
            desert: {
                name: 'Desert ðŸŒµ',
                bg: 'linear-gradient(to top, #e65c00, #F9D423)',
                main: '#4e342e', sub: '#795548', accent: '#bf360c',
                r1: '#d84315', r2: '#fb8c00', r3: '#fdd835',
                card: 'rgba(255, 245, 230, 0.6)', border: 'rgba(255, 200, 150, 0.5)',
                input: 'rgba(255, 255, 255, 0.4)', menu: 'rgba(255, 248, 240, 0.9)', hover: 'rgba(0,0,0,0.05)',
                header: 'rgba(255, 245, 230, 0.8)'
            }
        };

        const THEME_GROUPS = [
            { label: "Essentials", items: ["apple"] },
            { label: "Dark Mode", items: ["midnight", "cyberpunk", "galaxy", "terminal"] },
            { label: "Nature", items: ["forest", "ocean", "sunset", "desert"] },
            { label: "Aesthetic", items: ["coffee", "lavender", "candy", "barbie"] },
            { label: "Seasonal", items: ["christmas", "halloween", "winter", "summer"] },
        ];

        let lineChart = null;
        let barChart = null;
        let flowChart = null;
        let ringData = [
            { name: 'Focus', percent: 0, minutes: 0 },
            { name: 'Work', percent: 0, minutes: 0 },
            { name: 'System', percent: 0, minutes: 0 }
        ];

        const SONGS = [
            { title: "Midnight City", artist: "M83" },
            { title: "Nightcall", artist: "Kavinsky" },
            { title: "Blinding Lights", artist: "The Weeknd" },
            { title: "Lofi Study", artist: "Chillhop" },
            { title: "Cyberpunk 2077", artist: "Hyper" }
        ];
        let currentSongIdx = 0;
        let isPlaying = true;
        let musicProgress = 0;

        function initThemeMenu() {
            const container = document.getElementById("theme-list-container");
            if (!container) return;

            let html = "";
            THEME_GROUPS.forEach(group => {
                html += `<div class="px-4 py-1 mt-2 text-[10px] font-bold text-sub uppercase tracking-wider opacity-70">${group.label}</div>`;
                group.items.forEach(key => {
                    const t = THEMES[key];
                    if (!t) return;
                    html += `
                        <div onclick="changeTheme('${key}')" class="dropdown-item flex items-center gap-3 px-4 py-2 cursor-pointer transition-colors">
                            <div class="w-4 h-4 rounded-full shadow-sm ring-1 ring-black/10" style="background: ${t.bg}"></div>
                            <span class="text-xs font-medium text-main">${t.name}</span>
                        </div>
                    `;
                });
            });
            container.innerHTML = html;
        }

        function toggleThemeMenu() {
            const menu = document.getElementById("theme-menu");
            menu.classList.toggle("hidden");
        }

        document.addEventListener("click", function(e) {
            const menu = document.getElementById("theme-menu");
            const btn = document.getElementById("theme-btn");
            if (!menu.classList.contains("hidden") && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add("hidden");
            }
        });

        function changeTheme(themeName) {
            const t = THEMES[themeName] || THEMES.apple;
            const root = document.documentElement;

            root.style.setProperty('--bg-gradient', t.bg);
            root.style.setProperty('--text-main', t.main);
            root.style.setProperty('--text-sub', t.sub);
            root.style.setProperty('--accent-color', t.accent);
            root.style.setProperty('--ring-1', t.r1);
            root.style.setProperty('--ring-2', t.r2);
            root.style.setProperty('--ring-3', t.r3);
            root.style.setProperty('--card-bg', t.card);
            root.style.setProperty('--card-border', t.border);
            root.style.setProperty('--input-bg', t.input);
            root.style.setProperty('--menu-bg', t.menu || 'rgba(255, 255, 255, 0.85)');
            root.style.setProperty('--hover-bg', t.hover || 'rgba(0,0,0,0.05)');
            root.style.setProperty('--header-bg', t.header || 'rgba(255, 255, 255, 0.6)');

            const bar = document.getElementById('stat-bar');
            if (bar) {
                if (themeName === 'cyberpunk') {
                    bar.classList.add('rgb-bar');
                } else {
                    bar.classList.remove('rgb-bar');
                    bar.style.backgroundColor = getComputedStyle(root).getPropertyValue('--accent-color');
                }
            }

            updateDecorations(themeName);
            document.getElementById("current-theme-label").innerText = t.name.split(" ")[0];
            document.getElementById("theme-menu").classList.add("hidden");
            drawRings();
            refreshChartsFromState();
            renderTopApps(lastApps);
        }

        function updateDecorations(theme) {
            const layer = document.getElementById('decoration-layer');
            if (!layer) return;
            layer.innerHTML = '';

            if (theme === 'christmas' || theme === 'winter') {
                for (let i = 0; i < 50; i++) {
                    const el = document.createElement('div');
                    el.classList.add('deco-item');
                    el.innerHTML = 'â„ï¸';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.fontSize = Math.random() * 10 + 10 + 'px';
                    el.style.opacity = Math.random() * 0.5 + 0.3;
                    el.style.animation = `fall ${Math.random() * 5 + 5}s linear infinite`;
                    el.style.animationDelay = Math.random() * 5 + 's';
                    layer.appendChild(el);
                }
            }

            if (theme === 'halloween') {
                for (let i = 0; i < 15; i++) {
                    const el = document.createElement('div');
                    el.classList.add('deco-item');
                    el.innerHTML = Math.random() > 0.5 ? 'ðŸ‘»' : 'ðŸ¦‡';
                    el.style.left = Math.random() * 90 + 5 + 'vw';
                    el.style.fontSize = Math.random() * 20 + 20 + 'px';
                    el.style.animation = `float-up ${Math.random() * 10 + 10}s ease-in-out infinite`;
                    el.style.animationDelay = Math.random() * 5 + 's';
                    layer.appendChild(el);
                }
            }

            if (theme === 'galaxy') {
                 for (let i = 0; i < 60; i++) {
                    const el = document.createElement('div');
                    el.classList.add('deco-item');
                    el.innerHTML = 'âœ¨';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.top = Math.random() * 100 + 'vh';
                    el.style.fontSize = Math.random() * 10 + 5 + 'px';
                    el.style.color = '#fff';
                    el.style.animation = `twinkle ${Math.random() * 3 + 1}s ease-in-out infinite`;
                    layer.appendChild(el);
                }
            }

             if (theme === 'cyberpunk' || theme === 'terminal') {
                 for (let i = 0; i < 30; i++) {
                    const el = document.createElement('div');
                    el.classList.add('deco-item');
                    el.innerText = Math.random() > 0.5 ? '1' : '0';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.color = '#0f0';
                    el.style.fontFamily = 'monospace';
                    el.style.fontSize = Math.random() * 12 + 10 + 'px';
                    el.style.animation = `fall ${Math.random() * 2 + 1}s linear infinite`;
                    el.style.animationDelay = Math.random() * 2 + 's';
                    layer.appendChild(el);
                }
            }

            if (theme === 'forest') {
                 for (let i = 0; i < 20; i++) {
                    const el = document.createElement('div');
                    el.classList.add('deco-item');
                    el.style.width = '6px';
                    el.style.height = '6px';
                    el.style.background = '#a7f3d0';
                    el.style.borderRadius = '50%';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.boxShadow = '0 0 10px #a7f3d0';
                    el.style.animation = `float-up ${Math.random() * 15 + 10}s ease-in-out infinite`;
                    el.style.animationDelay = Math.random() * 5 + 's';
                    layer.appendChild(el);
                }
            }
        }

        function formatMinutesFriendly(minutes) {
            const m = minutes || 0;
            if (m >= 60) {
                const hours = m / 60;
                if (Math.abs(hours - Math.round(hours)) < 0.05) {
                    return `${Math.round(hours)}h`;
                }
                return `${hours.toFixed(1)}h`;
            }
            if (m >= 10) {
                return `${Math.round(m)}m`;
            }
            return `${m.toFixed(1)}m`;
        }

        function formatPercent(value) {
            if (value === null || value === undefined || Number.isNaN(value)) return '0%';
            return `${Math.round(value)}%`;
        }

        async function fetchJson(url) {
            try {
                const res = await fetch(url, { cache: 'no-store' });
                if (!res.ok) throw new Error('Request failed');
                return await res.json();
            } catch (e) {
                console.warn('Failed to fetch', url, e);
                return null;
            }
        }

        function updateFocus(latest) {
            const modeEl = document.getElementById('stat-mode');
            const confEl = document.getElementById('stat-conf');
            const barEl = document.getElementById('stat-bar');

            if (!latest) {
                if (modeEl) modeEl.innerText = 'Waiting for data';
                if (confEl) confEl.innerText = '--';
                if (barEl) barEl.style.width = '0%';
                return;
            }

            const mode = latest.mode || 'Unknown';
            const confidence = (latest.confidence || 0) * 100;
            if (modeEl) modeEl.innerText = mode;
            if (confEl) confEl.innerText = `${confidence.toFixed(0)}%`;
            if (barEl) {
                barEl.style.width = `${Math.min(confidence, 100)}%`;
                if (!barEl.classList.contains('rgb-bar')) {
                    barEl.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color');
                }
            }
        }

        function annotateDurations(logs) {
            return (logs || []).map((entry, idx) => {
                const next = logs[idx + 1];
                const currentTs = entry?.ts ? new Date(entry.ts) : null;
                const nextTs = next?.ts ? new Date(next.ts) : null;

                let minutes = null;
                if (currentTs) {
                    const end = nextTs || new Date();
                    minutes = Math.max((end - currentTs) / 60000, 0);
                }

                return {
                    ...entry,
                    duration_minutes: minutes,
                };
            });
        }

        function renderLogs(logs) {
            const logContainer = document.getElementById('log-body');
            if (!logContainer) return;
            logContainer.innerHTML = '';

            (logs || []).slice(0, 25).forEach(entry => {
                const time = entry.ts_display || entry.ts || '--';
                const row = document.createElement('tr');
                row.className = 'hover:bg-white/10 transition-colors rounded-lg group';
                row.innerHTML = `
                    <td class="py-2.5 px-3 text-[10px] font-medium text-sub tabular-nums w-14 align-top pt-3">${time}</td>
                    <td class="py-2 px-1">
                        <div class="flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
                            <span class="text-xs font-semibold text-main truncate">${entry.exe || 'Unknown app'}</span>
                            ${entry.mode ? `<span class="text-[9px] uppercase tracking-wide px-1.5 py-0.5 rounded bg-black/5 text-sub">${entry.mode}</span>` : ''}
                        </div>
                        <div class="text-[10px] text-sub truncate">${entry.title || ''}</div>
                        ${entry.duration_minutes !== null && entry.duration_minutes !== undefined ? `<div class="text-[10px] text-sub mt-0.5">Duration: ${formatMinutesFriendly(entry.duration_minutes)}</div>` : ''}
                    </td>
                `;
                logContainer.appendChild(row);
            });
        }

        function renderHistory(logs) {
            const tbody = document.getElementById('history-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            (logs || []).slice(0, 8).forEach(entry => {
                const efficiency = entry.confidence ? `${Math.round(entry.confidence * 100)}%` : '--';
                const status = entry.mode ? entry.mode.toUpperCase() : 'LOGGED';
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-white/10 transition-colors';
                tr.innerHTML = `
                    <td class="p-4">${entry.ts_display || entry.ts || '--'}</td>
                    <td class="p-4 font-medium">${entry.title || entry.exe || 'Unknown activity'}</td>
                    <td class="p-4">${entry.duration_minutes !== null && entry.duration_minutes !== undefined ? formatMinutesFriendly(entry.duration_minutes) : '--'}</td>
                    <td class="p-4"><span class="text-green-500 font-bold">${efficiency}</span></td>
                    <td class="p-4"><span class="px-2 py-1 rounded-md bg-green-500/20 text-green-600 text-xs font-bold uppercase">${status}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderTopApps(apps) {
            const container = document.getElementById('top-apps-list');
            if (!container) return;
            const list = apps && apps.length ? apps : [];
            if (!list.length) {
                container.innerHTML = '<div class="text-xs text-sub">No app activity yet.</div>';
                return;
            }
            const total = list.reduce((sum, a) => sum + (a.minutes || 0), 0) || 1;
            container.innerHTML = list.slice(0, 6).map(app => {
                const percent = Math.min((app.minutes || 0) / total * 100, 100);
                return `
                <div class="flex items-center gap-3 group cursor-default">
                    <div class="w-10 h-10 squircle bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white shadow-sm text-sm font-bold shrink-0">
                        ${(app.exe || app.name || '?').charAt(0)}
                    </div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-semibold text-main truncate">${app.exe || app.name}</span>
                            <span class="text-[10px] font-medium text-sub">${formatMinutesFriendly(app.minutes)}</span>
                        </div>
                        <div class="w-full bg-black/5 h-1.5 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-blue-500 to-blue-600 rounded-full" style="width: ${percent}%"></div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderGoals(goals) {
            const list = document.getElementById('goals-list');
            const summary = document.getElementById('goals-summary');
            if (!list || !summary) return;
            if (!goals || !goals.length) {
                list.innerHTML = '<div class="text-xs text-sub">Connect an Obsidian vault to see your tasks.</div>';
                summary.innerText = '0/0';
                return;
            }

            const completed = goals.filter(g => g.done).length;
            summary.innerText = `${completed}/${goals.length}`;
            list.innerHTML = goals.slice(0, 5).map(goal => `
                <label class="flex items-center gap-3 group cursor-pointer">
                    <input type="checkbox" class="custom-checkbox" ${goal.done ? 'checked' : ''} disabled>
                    <span class="text-xs font-medium ${goal.done ? 'text-sub line-through opacity-70' : 'text-main'} group-hover:opacity-80 transition-colors truncate">${goal.title || 'Task'}</span>
                    ${goal.due ? `<span class="text-[10px] font-semibold text-sub bg-white/30 px-2 py-0.5 rounded">${goal.due}</span>` : ''}
                </label>
            `).join('');
        }

        function renderSystem(snapshot) {
            if (!snapshot) return;
            const cpuVal = document.getElementById('cpu-val');
            const cpuBar = document.getElementById('cpu-bar');
            const ramVal = document.getElementById('ram-val');
            const ramBar = document.getElementById('ram-bar');

            if (cpuVal) cpuVal.innerText = snapshot.cpu_load !== null && snapshot.cpu_load !== undefined ? `${snapshot.cpu_load.toFixed(0)}%` : '--';
            if (cpuBar && snapshot.cpu_load !== null && snapshot.cpu_load !== undefined) {
                cpuBar.style.width = `${Math.min(snapshot.cpu_load, 100)}%`;
            }

            if (ramVal) {
                const total = snapshot.ram_total_gb ? snapshot.ram_total_gb.toFixed(1) : '?';
                const used = snapshot.ram_used_gb ? snapshot.ram_used_gb.toFixed(1) : '?';
                ramVal.innerText = snapshot.ram_percent ? `${used} / ${total} GB` : '--';
            }
            if (ramBar && snapshot.ram_percent !== null && snapshot.ram_percent !== undefined) {
                ramBar.style.width = `${Math.min(snapshot.ram_percent, 100)}%`;
            }
        }

        function updateRingsFromDayStats(dayStats) {
            const entries = Object.entries(dayStats || {}).sort((a, b) => b[1] - a[1]);
            const totalMinutes = entries.reduce((sum, [, minutes]) => sum + minutes, 0) || 1;
            const top = entries.slice(0, 3);
            while (top.length < 3) top.push(['Idle', 0]);

            ringData = top.map(([name, minutes]) => ({
                name,
                minutes,
                percent: Math.min(minutes / totalMinutes, 1)
            }));

            ['ring-1', 'ring-2', 'ring-3'].forEach((id, idx) => {
                const nameEl = document.getElementById(`${id}-name`);
                const valEl = document.getElementById(`${id}-value`);
                const data = ringData[idx];
                if (nameEl) nameEl.innerText = (data?.name || 'N/A').slice(0, 8);
                if (valEl) valEl.innerText = formatMinutesFriendly(data?.minutes || 0);
            });

            drawRings();
        }

        function drawRings() {
            const canvas = document.getElementById('ringsCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            const dpr = window.devicePixelRatio || 1;
            canvas.width = 140 * dpr;
            canvas.height = 140 * dpr;
            canvas.style.width = "140px";
            canvas.style.height = "140px";
            ctx.scale(dpr, dpr);

            const w = 140;
            const center = w / 2;
            ctx.clearRect(0, 0, w, w);
            ctx.lineCap = 'round';

            const styles = getComputedStyle(document.documentElement);
            const colors = [
                styles.getPropertyValue('--ring-1').trim(),
                styles.getPropertyValue('--ring-2').trim(),
                styles.getPropertyValue('--ring-3').trim(),
            ];

            const radii = [55, 40, 25];
            ringData.forEach((ring, idx) => {
                const radius = radii[idx];
                const color = colors[idx] || '#000';
                ctx.beginPath();
                ctx.arc(center, center, radius, 0, 2 * Math.PI);
                ctx.strokeStyle = color;
                ctx.globalAlpha = 0.2;
                ctx.lineWidth = 10;
                ctx.stroke();

                ctx.globalAlpha = 1.0;
                ctx.beginPath();
                ctx.arc(center, center, radius, -Math.PI / 2, (-Math.PI / 2) + (2 * Math.PI * (ring.percent || 0)));
                ctx.stroke();
            });
        }

        function buildHourBuckets(timeline) {
            const now = new Date();
            const start = new Date(now.getTime() - 60 * 60000);
            const buckets = Array(6).fill(0);
            const labels = Array.from({ length: 6 }, (_, i) => {
                const ts = new Date(start.getTime() + i * 10 * 60000);
                return ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            });

            const sorted = (timeline || [])
                .map(t => ({ ...t, ts: t.ts ? new Date(t.ts) : null }))
                .filter(t => t.ts && t.ts >= start)
                .sort((a, b) => a.ts - b.ts);

            if (!sorted.length) {
                return { labels, buckets };
            }

            let lastTs = start;

            const addDuration = (from, to) => {
                let s = from.getTime();
                const end = to.getTime();
                while (s < end) {
                    const bucketIdx = Math.min(5, Math.floor((s - start.getTime()) / (10 * 60000)));
                    const bucketEnd = Math.min(start.getTime() + (bucketIdx + 1) * 10 * 60000, end);
                    buckets[bucketIdx] += (bucketEnd - s) / 60000;
                    s = bucketEnd;
                }
            };

            sorted.forEach(entry => {
                const ts = entry.ts;
                const clamped = ts < start ? start : ts;
                addDuration(lastTs, clamped);
                lastTs = clamped;
            });

            addDuration(lastTs, now);

            return { labels, buckets };
        }

        function refreshLineChart(hourTimeline) {
            const { labels, buckets } = buildHourBuckets(hourTimeline);
            const canvas = document.getElementById('lineChart');
            if (!canvas) return;
            const styles = getComputedStyle(document.documentElement);
            const mainColor = styles.getPropertyValue('--text-main').trim();
            const subColor = styles.getPropertyValue('--text-sub').trim();
            const ctx = canvas.getContext('2d');

            if (!lineChart) {
                const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                gradient.addColorStop(0, `${mainColor}22`);
                gradient.addColorStop(1, `${mainColor}00`);
                lineChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ data: buckets, label: 'Active minutes' }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: subColor, font: { family: 'Inter', size: 10 } } },
                            y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: subColor, callback: v => formatMinutesFriendly(v) } }
                        }
                    }
                });
            }

            lineChart.data.labels = labels;
            lineChart.data.datasets = [{
                label: 'Active minutes',
                data: buckets,
                borderColor: mainColor,
                backgroundColor: `${mainColor}22`,
                borderWidth: 2,
                tension: 0.35,
                pointRadius: 0,
                fill: true,
            }];
            lineChart.update();
        }

        function refreshDeepAnalytics(dayStats) {
            const canvas = document.getElementById('barChart');
            if (!canvas) return;
            const styles = getComputedStyle(document.documentElement);
            const accentColor = styles.getPropertyValue('--accent-color').trim();
            const subColor = styles.getPropertyValue('--text-sub').trim();

            const entries = Object.entries(dayStats || {}).sort((a, b) => b[1] - a[1]).slice(0, 7);
            const labels = entries.map(([mode]) => mode);
            const values = entries.map(([, minutes]) => minutes / 60);

            const ctx = canvas.getContext('2d');
            if (!barChart) {
                barChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ data: values, backgroundColor: accentColor, borderRadius: 6 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: subColor } },
                            y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { display: false } }
                        }
                    }
                });
            }

            barChart.data.labels = labels;
            barChart.data.datasets[0].data = values;
            barChart.data.datasets[0].backgroundColor = accentColor;
            barChart.update();
        }

        function refreshFlowChart(hourTimeline) {
            const canvas = document.getElementById('flowChart');
            if (!canvas) return;
            const { labels, buckets } = buildHourBuckets(hourTimeline);
            const styles = getComputedStyle(document.documentElement);
            const accentColor = styles.getPropertyValue('--accent-color').trim();
            const subColor = styles.getPropertyValue('--text-sub').trim();
            const ctx = canvas.getContext('2d');

            if (!flowChart) {
                flowChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ data: buckets, backgroundColor: accentColor, borderRadius: 10, borderSkipped: false, barThickness: 16 }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: subColor, font: { size: 10 } }, border: { display: false } },
                            y: { display: false }
                        }
                    }
                });
            }

            flowChart.data.labels = labels;
            flowChart.data.datasets[0].data = buckets;
            flowChart.data.datasets[0].backgroundColor = accentColor;
            flowChart.update();
        }

        function refreshChartsFromState() {
            refreshLineChart(lastHourTimeline);
            refreshDeepAnalytics(lastDayStats);
            refreshFlowChart(lastHourTimeline);
        }

        function renderBadges() {
            const container = document.getElementById("badges-container");
            if (!container) return;

            const badges = [
                { name: 'Inbox Zero', icon: 'M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z', earned: true },
                { name: 'Deep Work', icon: 'M13 10V3L4 14h7v7l9-11h-7z', earned: true },
                { name: 'Night Owl', icon: 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z', earned: true },
                { name: 'Early Bird', icon: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707', earned: false },
                { name: 'Zen Master', icon: 'M12 19l9 2-9-18-9 18 9-2zm0 0v-8', earned: false },
                { name: 'Code Warrior', icon: 'M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4', earned: true },
                { name: 'Streak King', icon: 'M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z', earned: false },
                { name: 'Clean Desk', icon: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10', earned: true },
            ];

            container.innerHTML = badges.map(b => `
                <div class="aspect-square rounded-xl badge-slot flex items-center justify-center relative group cursor-help ${b.earned ? 'earned' : ''}">
                    <svg class="w-6 h-6 badge-icon text-main" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="${b.icon}"></path>
                    </svg>
                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-black/80 text-white text-[10px] rounded opacity-0 group-hover:opacity-100 transition pointer-events-none whitespace-nowrap">
                        ${b.name} ${b.earned ? 'âœ“' : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateMusicProgress() {
            if (!isPlaying) return;
            musicProgress += 1;
            if (musicProgress > 100) {
                musicProgress = 0;
                skipSong(1);
            }
            const bar = document.getElementById("music-progress");
            if(bar) bar.style.width = musicProgress + "%";
        }

        function skipSong(dir) {
            currentSongIdx += dir;
            if (currentSongIdx < 0) currentSongIdx = SONGS.length - 1;
            if (currentSongIdx >= SONGS.length) currentSongIdx = 0;

            const song = SONGS[currentSongIdx];
            document.getElementById("music-title").innerText = song.title;
            document.getElementById("music-artist").innerText = song.artist;
            musicProgress = 0;
            document.getElementById("music-progress").style.width = "0%";
        }

        function togglePlay() {
            isPlaying = !isPlaying;
            const btn = document.getElementById("play-btn");
            if (isPlaying) {
                 btn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>';
            } else {
                 btn.innerHTML = '<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>';
            }
        }

        let lastLogs = [];
        let lastDayStats = {};
        let lastHourTimeline = [];
        let lastApps = [];

        async function refreshDashboard() {
            const [logs, dayStats, hourTimeline, apps, systemSnapshot, goals] = await Promise.all([
                fetchJson('/api/latest'),
                fetchJson('/api/stats/day'),
                fetchJson('/api/stats/hour'),
                fetchJson('/api/stats/apps'),
                fetchJson('/api/system'),
                fetchJson('/api/goals'),
            ]);

            lastLogs = annotateDurations(logs || []);
            lastDayStats = dayStats || {};
            lastHourTimeline = hourTimeline || [];
            lastApps = apps || [];

            updateFocus(lastLogs[0]);
            renderLogs(lastLogs);
            renderHistory(lastLogs);
            renderTopApps(lastApps);
            renderGoals(goals?.goals);
            renderSystem(systemSnapshot);
            updateRingsFromDayStats(lastDayStats);
            refreshChartsFromState();
        }

        setInterval(() => {
            const clockEl = document.getElementById("clock");
            if (clockEl) clockEl.innerText = new Date().toLocaleTimeString('en-US', {hour12: false});
            updateMusicProgress();
        }, 1000);

        window.addEventListener('load', () => {
            initThemeMenu();
            drawRings();
            renderBadges();
            refreshDashboard();
            setInterval(refreshDashboard, 8000);
            togglePlay();

            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(-5px); }
                    to { opacity: 1; transform: translateY(0); }
                }
            `;
            document.head.appendChild(style);
        });

    </script>
</body>
</html>
